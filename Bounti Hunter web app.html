<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bounti Hunter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Basic style overrides and theme application */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark background (Tailwind gray-900) */
            color: #F9FAFB; /* Light text (Tailwind gray-50) */
        }
        .title-gradient {
            background: linear-gradient(to right, #34D399, #10B981); /* Green gradient (Tailwind emerald-400 to emerald-600) */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        /* Style form elements for consistency */
        input[type="text"],
        input[type="email"],
        input[type="password"],
        textarea,
        select {
            background-color: #374151; /* Tailwind gray-700 */
            border: 1px solid #4B5563; /* Tailwind gray-600 */
            color: #F9FAFB; /* Tailwind gray-50 */
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.5rem 0.75rem; /* p-2 px-3 */
            width: 100%; /* Ensure they take full width of container */
        }
        input::placeholder,
        textarea::placeholder {
            color: #9CA3AF; /* Tailwind gray-400 */
        }
        button {
            transition: all 0.2s ease-in-out;
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.6rem 1.2rem; /* Slightly larger padding */
            font-weight: 500; /* medium */
            cursor: pointer;
        }
         button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .btn-primary {
            background-color: #10B981; /* Tailwind emerald-600 */
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #059669; /* Tailwind emerald-700 */
        }
        .btn-secondary {
            background-color: #4B5563; /* Tailwind gray-600 */
            color: white;
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: #374151; /* Tailwind gray-700 */
        }
         .btn-danger {
            background-color: #EF4444; /* Tailwind red-500 */
            color: white;
        }
        .btn-danger:hover:not(:disabled) {
            background-color: #DC2626; /* Tailwind red-600 */
        }
        /* Modal Styling */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6); /* Semi-transparent black background */
            -webkit-backdrop-filter: blur(3px); /* Safari 9+, iOS 9+ */
            backdrop-filter: blur(3px); /* Optional blur effect */
        }
        .modal-content {
            background-color: #1F2937; /* Tailwind gray-800 */
            margin: 10% auto;
            padding: 2rem;
            border: 1px solid #4B5563; /* Tailwind gray-600 */
            width: 80%;
            max-width: 600px;
            border-radius: 0.5rem; /* rounded-lg */
            color: #F9FAFB; /* Tailwind gray-50 */
        }
        /* Ensure responsiveness */
        img {
            max-width: 100%;
            height: auto;
            border-radius: 0.375rem; /* rounded-md */
        }
        /* Helper class to hide elements visually but keep them accessible */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        /* Hide admin section by default, replaces inline style */
        .hidden-admin-section {
            display: none;
        }
        /* Hide app container by default, replaces inline style */
        .hidden-app-container {
            display: none;
        }
        /* Hide firebase status by default, replaces inline style */
        .hidden-firebase-status {
            display: none;
        }
    </style>
</head>
<body class="antialiased">

    <div id="tos-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="tos-heading">
        <div class="modal-content">
            <h2 id="tos-heading" class="text-2xl font-bold mb-4 text-emerald-500">Terms of Service</h2>
            <p class="mb-4 text-gray-300">Please read these terms carefully. By clicking "Agree", you acknowledge that you have read, understood, and agree to be bound by these terms. [Your Full Terms of Service Text Here - This is a placeholder!]</p>
            <p class="mb-6 text-gray-300">Lorem ipsum dolor sit amet consectetur adipisicing elit. Quisquam, voluptatum. Voluptates, quod. Quisquam, voluptatum. Voluptates, quod.</p>
            <div class="text-right">
                <button id="agree-tos-btn" class="btn-primary">Agree</button>
    <div id="app-container" class="container mx-auto px-4 py-8 hidden-app-container"> <header class="text-center mb-12">
        </div>
    </div>

    <div id="app-container" class="container mx-auto px-4 py-8 hidden-app-container"> <header class="text-center mb-12">
            <h1 class="text-5xl font-bold title-gradient mb-4">Bounti Hunter</h1>
        <div id="firebase-status" class="text-center text-sm text-yellow-500 mb-4 hidden-firebase-status">Connecting to services...</div>
            <a href="#admin" id="admin-link" class="text-emerald-400 hover:text-emerald-300 mt-2 inline-block">Admin Access</a>
        </header>

        <div id="firebase-status" class="text-center text-sm text-yellow-500 mb-4 hidden-firebase-status">Connecting to services...</div>

        <section id="tip-submission" aria-labelledby="tip-heading" class="mb-12 bg-gray-800 p-6 rounded-lg shadow-lg">
            <h2 id="tip-heading" class="text-2xl font-semibold mb-4 text-emerald-500">Submit a Tip Anonymously</h2>
            <form id="tip-form">
                <div class="mb-4">
                    <label for="tip-details" class="block text-sm font-medium text-gray-300 mb-1">Tip Details:</label>
                    <textarea id="tip-details" name="tip-details" rows="4" placeholder="Enter all relevant information..." required class="shadow-sm focus:ring-emerald-500 focus:border-emerald-500 block w-full sm:text-sm border-gray-600 rounded-md bg-gray-700 text-gray-50 disabled:opacity-50" aria-describedby="tip-submission-status"></textarea>
                </div>
                <button type="submit" id="submit-tip-btn" class="btn-primary w-full sm:w-auto disabled:opacity-50 disabled:cursor-not-allowed">Submit Tip</button>
            </form>
            <p id="tip-submission-status" class="mt-4 text-sm text-emerald-400" aria-live="polite"></p>
        </section>

        <section id="filters" aria-labelledby="filter-heading" class="mb-8 bg-gray-800 p-6 rounded-lg shadow-lg">
            <h2 id="filter-heading" class="text-xl font-semibold mb-4 text-emerald-500">Filter Alerts</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div>
                    <label for="filter-armed" class="block text-sm font-medium text-gray-300 mb-1">Status:</label>
                    <select id="filter-armed" name="filter-armed" class="filter-select bg-gray-700 border border-gray-600 text-gray-50 rounded-md p-2 w-full focus:ring-emerald-500 focus:border-emerald-500">
                        <option value="">Any</option>
                        <option value="yes">Armed and Dangerous</option>
                        <option value="no">Not Specified as Armed</option>
                    </select>
                </div>
                <div>
                    <label for="filter-location" class="block text-sm font-medium text-gray-300 mb-1">Location:</label>
                    <select id="filter-location" name="filter-location" class="filter-select bg-gray-700 border border-gray-600 text-gray-50 rounded-md p-2 w-full focus:ring-emerald-500 focus:border-emerald-500">
                        <option value="">All Locations</option>
                        <optgroup label="Continents">
                            <option value="Africa">Africa</option>
                            <option value="Antarctica">Antarctica</option>
                            <option value="Asia">Asia</option>
                            <option value="Europe">Europe</option>
                            <option value="North America">North America</option>
                            <option value="Oceania">Oceania</option>
                            <option value="South America">South America</option>
                        </optgroup>
                        <optgroup label="US States">
                            {/* Populated by JS */}
                        </optgroup>
                    </select>
                </div>
                <div>
                    <label for="filter-crime-type" class="block text-sm font-medium text-gray-300 mb-1">Crime Type:</label>
                    <select id="filter-crime-type" name="filter-crime-type" class="filter-select bg-gray-700 border border-gray-600 text-gray-50 rounded-md p-2 w-full focus:ring-emerald-500 focus:border-emerald-500">
                        <option value="">All Crime Types</option>
                        <option value="Violent Crimes">Violent Crimes</option>
                        <option value="Property Crimes">Property Crimes</option>
                        <option value="White Collar Crimes">White Collar Crimes</option>
                        <option value="Drug Crimes">Drug Crimes</option>
                        <option value="Cyber Crimes">Cyber Crimes</option>
                        <option value="Public Order Crimes">Public Order Crimes</option>
                        <option value="Sex Crimes">Sex Crimes</option>
                        <option value="Organized Crime">Organized Crime</option>
                        <option value="Terrorism">Terrorism/National Security</option>
                    </select>
                </div>
                <div>
                    <label for="filter-amount" class="block text-sm font-medium text-gray-300 mb-1">Amount Range ($):</label>
                    <select id="filter-amount" name="filter-amount" class="filter-select bg-gray-700 border border-gray-600 text-gray-50 rounded-md p-2 w-full focus:ring-emerald-500 focus:border-emerald-500">
                        <option value="">Any Amount</option>
                        <option value="0-50000">$50,000 and lower</option>
                        <option value="50001-150000">$50,001 - $150,000</option>
                        <option value="150001-250000">$150,001 - $250,000</option>
                        <option value="250001+">$250,001 and Above</option>
                    </select>
                </div>
            </div>
             <button id="apply-filters-btn" class="btn-secondary mt-4">Apply Filters</button>
        </section>

        <section id="alerts-display" aria-labelledby="alerts-heading">
            <h2 id="alerts-heading" class="text-2xl font-semibold mb-6 text-emerald-500">Current Alerts</h2>
            <div id="alerts-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <section id="admin-section" class="mt-16 pt-8 border-t border-gray-700 hidden-admin-section" aria-labelledby="admin-heading">
             <p id="loading-status" class="text-center text-gray-400 mt-8" aria-live="polite">Loading alerts...</p>
        </section>

        <section id="admin-section" class="mt-16 pt-8 border-t border-gray-700 hidden-admin-section" aria-labelledby="admin-heading">
            <h2 id="admin-heading" class="text-3xl font-bold text-center mb-8 text-emerald-500">Admin Panel</h2>

            <div id="admin-login" class="max-w-md mx-auto bg-gray-800 p-6 rounded-lg shadow-lg">
                <h3 class="text-xl font-semibold mb-4">Admin Login</h3>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="email-login" class="block text-sm font-medium text-gray-300 mb-1">Email:</label>
                        <input type="email" id="email-login" name="email" required placeholder="admin@example.com" class="disabled:opacity-50">
                    </div>
                    <div class="mb-4">
                        <label for="password-login" class="block text-sm font-medium text-gray-300 mb-1">Password:</label>
                        <input type="password" id="password-login" name="password" required placeholder="••••••••" class="disabled:opacity-50">
                    </div>
                    <button type="submit" id="login-btn" class="btn-primary w-full disabled:opacity-50 disabled:cursor-not-allowed">Login</button>
                    <p id="login-error" class="text-red-500 text-sm mt-2" aria-live="assertive"></p>
                </form>
            </div>

            <div id="admin-content" class="mt-8 hidden-admin-section">
                 <div class="text-right mb-4 max-w-4xl mx-auto px-4">
                     <span id="admin-email" class="text-gray-400 mr-4 text-sm hidden sm:inline"></span>
                     <button id="logout-btn" class="btn-secondary">Logout</button>
                 </div>

                <h3 class="text-xl font-semibold mb-6 text-center text-emerald-500">Manage Alerts</h3>

                <div class="mb-12 bg-gray-800 p-6 rounded-lg shadow-lg max-w-lg mx-auto">
                    <h4 class="text-lg font-semibold mb-4">Add New Alert</h4>
                    <form id="add-alert-form">
                        <div class="mb-4">
                            <label for="alert-image-add" class="block text-sm font-medium text-gray-300 mb-1">Image:</label>
                            <input type="file" id="alert-image-add" name="alert-image" accept="image/*" required class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-emerald-600 file:text-white hover:file:bg-emerald-700 disabled:opacity-50">
                        </div>
                         <div class="mb-4">
                            <label for="alert-description-add" class="block text-sm font-medium text-gray-300 mb-1">Description:</label>
                            <textarea id="alert-description-add" name="alert-description" rows="3" required placeholder="Brief description of the alert..." class="shadow-sm focus:ring-emerald-500 focus:border-emerald-500 block w-full sm:text-sm border-gray-600 rounded-md bg-gray-700 text-gray-50 disabled:opacity-50"></textarea>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                             <div>
                                <label for="add-armed" class="block text-sm font-medium text-gray-300 mb-1">Status:</label>
                                <select id="add-armed" name="add-armed" required class="bg-gray-700 border border-gray-600 text-gray-50 rounded-md p-2 w-full focus:ring-emerald-500 focus:border-emerald-500 disabled:opacity-50">
                                    <option value="">Select Status</option>
                                    <option value="yes">Armed and Dangerous</option>
                                    <option value="no">Not Specified as Armed</option>
                                </select>
                            </div>
                             <div>
                                <label for="add-location" class="block text-sm font-medium text-gray-300 mb-1">Location:</label>
                                <select id="add-location" name="add-location" required class="bg-gray-700 border border-gray-600 text-gray-50 rounded-md p-2 w-full focus:ring-emerald-500 focus:border-emerald-500 disabled:opacity-50">
                                    <option value="">Select Location</option>
                                     <optgroup label="Continents">
                                        <option value="Africa">Africa</option>
                                        <option value="Antarctica">Antarctica</option>
                                        <option value="Asia">Asia</option>
                                        <option value="Europe">Europe</option>
                                        <option value="North America">North America</option>
                                        <option value="Oceania">Oceania</option>
                                        <option value="South America">South America</option>
                                    </optgroup>
                                    <optgroup label="US States">
                                       {/* Populated by JS */}
                                    </optgroup>
                                </select>
                            </div>
                             <div>
                                <label for="add-crime-type" class="block text-sm font-medium text-gray-300 mb-1">Crime Type:</label>
                                <select id="add-crime-type" name="add-crime-type" required class="bg-gray-700 border border-gray-600 text-gray-50 rounded-md p-2 w-full focus:ring-emerald-500 focus:border-emerald-500 disabled:opacity-50">
                                     <option value="">Select Crime Type</option>
                                    <option value="Violent Crimes">Violent Crimes</option>
                                    <option value="Property Crimes">Property Crimes</option>
                                    <option value="White Collar Crimes">White Collar Crimes</option>
                                    <option value="Drug Crimes">Drug Crimes</option>
                                    <option value="Cyber Crimes">Cyber Crimes</option>
                                    <option value="Public Order Crimes">Public Order Crimes</option>
                                    <option value="Sex Crimes">Sex Crimes</option>
                                    <option value="Organized Crime">Organized Crime</option>
                                    <option value="Terrorism">Terrorism/National Security</option>
                                </select>
                            </div>
                             <div>
                                <label for="add-amount" class="block text-sm font-medium text-gray-300 mb-1">Amount Range ($):</label>
                                <select id="add-amount" name="add-amount" required class="bg-gray-700 border border-gray-600 text-gray-50 rounded-md p-2 w-full focus:ring-emerald-500 focus:border-emerald-500 disabled:opacity-50">
                                    <option value="">Select Amount</option>
                                    <option value="0-50000">$50,000 and lower</option>
                                    <option value="50001-150000">$50,001 - $150,000</option>
                                    <option value="150001-250000">$150,001 - $250,000</option>
                                    <option value="250001+">$250,001 and Above</option>
                                </select>
                            </div>
                         </div>
                        <button type="submit" id="add-alert-btn" class="btn-primary w-full disabled:opacity-50 disabled:cursor-not-allowed">Add Alert</button>
                         <p id="add-alert-status" class="mt-4 text-sm text-emerald-400" aria-live="polite"></p>
                    </form>
                </div>

                <div class="max-w-4xl mx-auto px-4">
                    <h4 class="text-lg font-semibold mb-4 text-center">Existing Alerts (Click X to Delete)</h4>
                    <div id="admin-alerts-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        </div>
                     <p id="admin-loading-status" class="text-center text-gray-400 mt-4" aria-live="polite">Loading admin alerts...</p>
                </div>
            </div>
        </section>

    </div> <script type="module">
        // Import functions from the Firebase SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, doc, deleteDoc, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-storage.js";

        // ---=== PASTE YOUR FIREBASE CONFIGURATION OBJECT HERE ===---
        // Replace the placeholder values with your actual Firebase project config.
        // DO NOT commit this file with real keys if your repo is public!
        const firebaseConfig = {
             apiKey: "YOUR_API_KEY", // <-- REPLACE
             authDomain: "YOUR_PROJECT_ID.firebaseapp.com", // <-- REPLACE
             projectId: "YOUR_PROJECT_ID", // <-- REPLACE
             storageBucket: "YOUR_PROJECT_ID.appspot.com", // <-- REPLACE
             messagingSenderId: "YOUR_SENDER_ID", // <-- REPLACE
             appId: "YOUR_APP_ID" // <-- REPLACE
        };
        // ---===================================================---

        // --- Global Variables & Firebase Initialization ---
        let app, auth, db, storage;
        let firebaseInitialized = false;
        const firebaseStatusDiv = document.getElementById('firebase-status');

        try {
            // Basic check if config seems placeholder or real
            if (firebaseConfig.apiKey && !firebaseConfig.apiKey.includes("YOUR_")) {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                storage = getStorage(app);
                firebaseInitialized = true;
                console.log("Firebase Initialized Successfully");
                if(firebaseStatusDiv) firebaseStatusDiv.style.display = 'none'; // Hide status if successful
            } else {
                 console.warn("Firebase configuration is missing or uses placeholder values. Please update firebaseConfig in the HTML.");
                 if(firebaseStatusDiv) {
                    firebaseStatusDiv.textContent = 'Firebase configuration missing or invalid. App functionality limited.';
                    firebaseStatusDiv.style.display = 'block';
                    firebaseStatusDiv.style.color = 'red'; // Make it more visible
                 }
            }
        } catch (error) {
            console.error("Firebase initialization failed:", error);
             if(firebaseStatusDiv) {
                firebaseStatusDiv.textContent = `Firebase Error: ${error.message}. Check console.`;
                firebaseStatusDiv.style.display = 'block';
                firebaseStatusDiv.style.color = 'red';
             }
            // Display a more user-friendly error on the page itself if needed
        }

        // --- DOM Elements ---
        const tosModal = document.getElementById('tos-modal');
        const agreeTosBtn = document.getElementById('agree-tos-btn');
        const appContainer = document.getElementById('app-container');
        const tipForm = document.getElementById('tip-form');
        const tipDetailsInput = document.getElementById('tip-details');
        const tipStatus = document.getElementById('tip-submission-status');
        const submitTipBtn = document.getElementById('submit-tip-btn');
        const alertsGrid = document.getElementById('alerts-grid');
        const loadingStatus = document.getElementById('loading-status');
        const adminLoadingStatus = document.getElementById('admin-loading-status');
        const applyFiltersBtn = document.getElementById('apply-filters-btn');
        const filterSelects = document.querySelectorAll('.filter-select'); // Get all filter dropdowns

        const adminSection = document.getElementById('admin-section');
        const adminLink = document.getElementById('admin-link');
        const adminLogin = document.getElementById('admin-login');
        const adminContent = document.getElementById('admin-content');
        const loginForm = document.getElementById('login-form');
        const loginBtn = document.getElementById('login-btn');
        const loginEmailInput = document.getElementById('email-login');
        const loginPasswordInput = document.getElementById('password-login');
        const loginError = document.getElementById('login-error');
        const logoutBtn = document.getElementById('logout-btn');
        const adminEmailSpan = document.getElementById('admin-email');
        const addAlertForm = document.getElementById('add-alert-form');
        const addAlertBtn = document.getElementById('add-alert-btn');
        const addAlertStatus = document.getElementById('add-alert-status');
        const adminAlertsList = document.getElementById('admin-alerts-list');
        const addAlertInputs = addAlertForm.querySelectorAll('input, textarea, select'); // For disabling form

        // --- Constants ---
        const TOS_KEY = 'tosAgreed';
        const ALERTS_COLLECTION = 'alerts'; // Firestore collection for alerts
        const TIPS_COLLECTION = 'tips';     // Firestore collection for tips
        const US_STATES = [ // Array for populating dropdowns
            "AL", "AK", "AZ", "AR", "CA", "CO", "CT", "DE", "FL", "GA",
            "HI", "ID", "IL", "IN", "IA", "KS", "KY", "LA", "ME", "MD",
            "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ",
            "NM", "NY", "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC",
            "SD", "TN", "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY"
        ];

        // --- Helper Functions ---
        function escapeHTML(str) {
            if (!str) return '';
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
            return str.replace(/[&<>"']/g, m => map[m]);
        }

        function getAmountLabel(rangeKey) {
            const labels = {
                "0-50000": "$50,000 and lower",
                "50001-150000": "$50,001 - $150,000",
                "150001-250000": "$150,001 - $250,000",
                "250001+": "$250,001 and Above"
            };
            return labels[rangeKey] || rangeKey;
        }

        // Function to populate state dropdowns
        function populateStateDropdowns() {
            const stateSelects = document.querySelectorAll('select[name="filter-location"] optgroup[label="US States"], select[name="add-location"] optgroup[label="US States"]');
            stateSelects.forEach(group => {
                group.innerHTML = ''; // Clear existing options
                US_STATES.forEach(state => {
                    const option = document.createElement('option');
                    option.value = state;
                    option.textContent = state; // Display abbreviation, or use a mapping for full names if desired
                    group.appendChild(option);
                });
            });
        }

        // --- Terms of Service Logic ---
        function checkTos() {
            if (localStorage.getItem(TOS_KEY) === 'true') {
                if(tosModal) tosModal.style.display = 'none';
                if(appContainer) appContainer.style.display = 'block';
                if(firebaseInitialized) loadAlerts(); // Load alerts only after ToS agreed and Firebase ready
            } else {
                if(tosModal) tosModal.style.display = 'block';
                if(appContainer) appContainer.style.display = 'none';
            }
        }

        if(agreeTosBtn) {
            agreeTosBtn.addEventListener('click', () => {
                localStorage.setItem(TOS_KEY, 'true');
                checkTos();
            });
        }

        // --- Tip Submission Logic ---
        if(tipForm) {
            tipForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const tipText = tipDetailsInput.value.trim();
                if (!tipText || !db || !firebaseInitialized) return; // Ensure tip has text and db is initialized

                // Disable form during submission
                submitTipBtn.disabled = true;
                tipDetailsInput.disabled = true;
                tipStatus.textContent = 'Submitting tip...';

                try {
                    // Add tip to Firestore
                    const docRef = await addDoc(collection(db, TIPS_COLLECTION), {
                        details: tipText,
                        submittedAt: serverTimestamp() // Use server timestamp
                    });
                    console.log("Tip submitted with ID: ", docRef.id);
                    tipStatus.textContent = 'Tip submitted successfully!';
                    tipDetailsInput.value = ''; // Clear the form
                    setTimeout(() => tipStatus.textContent = '', 3000); // Clear status message
                } catch (error) {
                    console.error("Error submitting tip: ", error);
                    tipStatus.textContent = 'Error submitting tip. Please try again.';
                } finally {
                    // Re-enable form
                    submitTipBtn.disabled = false;
                    tipDetailsInput.disabled = false;
                }
            });
        }

        // --- Alert Loading and Display Logic ---
        async function loadAlerts(filters = {}) {
            if (!db || !firebaseInitialized) {
                 if(loadingStatus) loadingStatus.textContent = 'Error: Database connection not available.';
                 return;
            }
            if(loadingStatus) loadingStatus.textContent = 'Loading alerts...';
            if(alertsGrid) alertsGrid.innerHTML = ''; // Clear existing alerts

            try {
                let alertsQuery = collection(db, ALERTS_COLLECTION);
                const queryConstraints = [orderBy('createdAt', 'desc')]; // Start with ordering

                // Apply filters dynamically
                if (filters.armed) {
                    queryConstraints.push(where("armed", "==", filters.armed === 'yes'));
                }
                if (filters.location) {
                     queryConstraints.push(where("location", "==", filters.location));
                }
                 if (filters.crimeType) {
                     queryConstraints.push(where("crimeType", "==", filters.crimeType));
                }
                 if (filters.amount) {
                     queryConstraints.push(where("amountRange", "==", filters.amount));
                }

                const q = query(alertsQuery, ...queryConstraints);

                // Note on Indexes: Firestore requires composite indexes for complex queries.
                // Check the browser console (F12) for errors if filters fail.
                // Firestore usually provides a direct link in the error message to create the index.

                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    if(loadingStatus) loadingStatus.textContent = 'No alerts found matching the criteria.';
                } else {
                    if(loadingStatus) loadingStatus.textContent = ''; // Hide loading message
                    querySnapshot.forEach((doc) => {
                        const alert = doc.data();
                        const alertId = doc.id;
                        displayAlert(alert, alertId);
                    });
                }
            } catch (error) {
                console.error("Error loading alerts: ", error);
                if(loadingStatus) loadingStatus.textContent = 'Error loading alerts. See console for details.';
                 if (error.code === 'failed-precondition') {
                     if(loadingStatus) loadingStatus.textContent += ' A Firestore index might be required. Check the developer console (F12) for a link to create it.';
                 } else if (error.code === 'permission-denied') {
                     if(loadingStatus) loadingStatus.textContent += ' Check Firestore security rules.';
                 }
            }
        }

        function displayAlert(alertData, id, isAdminView = false) {
            const targetGrid = isAdminView ? adminAlertsList : alertsGrid;
            if (!targetGrid) return; // Exit if the target grid doesn't exist

            const div = document.createElement('div');
             // Add base classes and conditional classes
            div.className = `p-4 rounded-lg shadow-md flex flex-col ${isAdminView ? 'bg-gray-700 relative group' : 'bg-gray-800'}`;

            if (isAdminView) {
                div.dataset.id = id; // Store Firestore document ID for deletion
                // Store the imagePath directly for reliable deletion
                div.dataset.imagePath = alertData.imagePath || '';
            }

            // Use optional chaining and default values for safety
            const description = escapeHTML(alertData?.description) || 'No description provided.';
            const imageUrl = alertData?.imageUrl || 'https://placehold.co/600x400/374151/FFF?text=Image+Not+Available';
            const statusText = alertData?.armed ? 'Armed and Dangerous' : 'Not Specified';
            const locationText = escapeHTML(alertData?.location) || 'N/A';
            const crimeTypeText = escapeHTML(alertData?.crimeType) || 'N/A';
            const amountText = escapeHTML(alertData?.amountRange ? getAmountLabel(alertData.amountRange) : 'N/A');
            const altText = description.substring(0, 50) || "Alert Image"; // Alt text for image

            div.innerHTML = `
                <img src="${imageUrl}" alt="${altText}" class="w-full ${isAdminView ? 'h-32' : 'h-48'} object-cover mb-4 rounded flex-shrink-0" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/600x400/374151/FFF?text=Image+Error';">
                <div class="flex-grow">
                    <p class="text-gray-300 ${isAdminView ? 'text-xs truncate' : 'text-sm mb-2'}" ${isAdminView ? `title="${description}"` : ''}>${description}</p>
                </div>
                 ${!isAdminView ? `
                <div class="mt-auto text-xs text-gray-400 space-y-1 pt-2 border-t border-gray-700">
                    <div>Status: <span class="font-medium">${statusText}</span></div>
                    <div>Location: <span class="font-medium">${locationText}</span></div>
                    <div>Type: <span class="font-medium">${crimeTypeText}</span></div>
                    <div>Amount: <span class="font-medium">${amountText}</span></div>
                </div>
                ` : ''}
                 ${isAdminView ? `
                 <button class="absolute top-2 right-2 bg-red-600 hover:bg-red-700 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 focus:opacity-100 transition-opacity text-xs btn-delete-alert" title="Delete Alert">
                    <span class="sr-only">Delete Alert</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                 ` : ''}
            `;

            targetGrid.appendChild(div);
        }

        // --- Filtering Logic ---
        if(applyFiltersBtn) {
            applyFiltersBtn.addEventListener('click', () => {
                const filters = {};
                filterSelects.forEach(select => {
                    if (select.value) {
                        // Extract filter name from ID (e.g., 'filter-location' -> 'location')
                        const filterName = select.id.replace('filter-', '');
                        filters[filterName] = select.value;
                    }
                });
                console.log("Applying filters:", filters);
                if(firebaseInitialized) loadAlerts(filters); // Only load if Firebase is ready
            });
        }

        // --- Routing / View Switching ---
        function showAdminView(show) {
             if (!adminSection || !appContainer) return;

            if (show) {
                 // Hide non-admin sections if desired (optional)
                 // tipSubmission.style.display = 'none';
                 // filters.style.display = 'none';
                 // alertsDisplay.style.display = 'none';
                adminSection.style.display = 'block';
                // Check auth state to show login or content
                checkAuthStateAndShowContent();
            } else {
                 // Show non-admin sections (make sure they exist first)
                 // if (tipSubmission) tipSubmission.style.display = 'block';
                 // if (filters) filters.style.display = 'block';
                 // if (alertsDisplay) alertsDisplay.style.display = 'block';
                adminSection.style.display = 'none';
                 if (adminLogin) adminLogin.style.display = 'block'; // Default to showing login when admin view is hidden
                 if (adminContent) adminContent.style.display = 'none';
            }
        }

        // Basic hash routing
        function handleRouteChange() {
            if (location.hash === '#admin') {
                showAdminView(true);
            } else {
                showAdminView(false);
                 // Ensure main app container is visible if ToS agreed
                 if(appContainer && localStorage.getItem(TOS_KEY) === 'true') {
                    appContainer.style.display = 'block';
                 }
            }
        }

        window.addEventListener('hashchange', handleRouteChange);

        // --- Admin Authentication Logic ---
        if(loginForm) {
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = loginEmailInput.value;
                const password = loginPasswordInput.value;
                 if(!auth || !firebaseInitialized) {
                     loginError.textContent = 'Authentication service not available.';
                     return;
                 }
                loginError.textContent = ''; // Clear previous errors
                loginBtn.disabled = true; // Disable button during login attempt
                loginEmailInput.disabled = true;
                loginPasswordInput.disabled = true;

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    // Auth state change (onAuthStateChanged) will handle UI update
                     console.log("Admin login successful");
                } catch (error) {
                    console.error("Admin login failed:", error);
                    if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                         loginError.textContent = 'Invalid email or password.';
                    } else {
                         loginError.textContent = `Login failed: ${error.message}`;
                    }
                    loginBtn.disabled = false; // Re-enable on failure
                    loginEmailInput.disabled = false;
                    loginPasswordInput.disabled = false;
                }
            });
        }

        if(logoutBtn) {
            logoutBtn.addEventListener('click', async () => {
                 if (!auth || !firebaseInitialized) return;
                try {
                    await signOut(auth);
                     console.log("Admin logged out");
                    // Auth state change will handle UI update
                    location.hash = ''; // Navigate away from admin section on logout
                } catch (error) {
                    console.error("Logout failed:", error);
                    alert("Logout failed. Please try again.");
                }
            });
        }

        // Listen for authentication state changes
        function checkAuthStateAndShowContent() {
             if (!auth || !firebaseInitialized) {
                 console.warn("Auth service not ready for state check.");
                 // Optionally hide admin content if auth isn't ready
                 if(adminLogin) adminLogin.style.display = 'block';
                 if(adminContent) adminContent.style.display = 'none';
                 return;
             }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // User is signed in - Show admin content ONLY if currently in #admin view
                     console.log("Auth State: Logged In", user.uid);
                    if (location.hash === '#admin') {
                         if(adminLogin) adminLogin.style.display = 'none';
                         if(adminContent) adminContent.style.display = 'block';
                         if(adminEmailSpan) adminEmailSpan.textContent = `Logged in as: ${user.email}`;
                         loadAdminAlerts(); // Load alerts for the admin view
                    }
                } else {
                    // User is signed out
                     console.log("Auth State: Logged Out");
                    if (location.hash === '#admin') {
                         // Still show admin section wrapper, but ensure login form is visible
                         if(adminLogin) adminLogin.style.display = 'block';
                         if(adminContent) adminContent.style.display = 'none';
                    } else {
                        // If not in #admin view, ensure admin section is hidden (handled by showAdminView)
                    }
                     if(adminAlertsList) adminAlertsList.innerHTML = ''; // Clear admin list on logout
                     if(adminEmailSpan) adminEmailSpan.textContent = '';
                     // Reset login form fields if needed
                     if(loginEmailInput) loginEmailInput.value = '';
                     if(loginPasswordInput) loginPasswordInput.value = '';
                     loginBtn.disabled = false;
                     loginEmailInput.disabled = false;
                     loginPasswordInput.disabled = false;
                }
            });
        }


        // --- Admin Content Management Logic ---

        // Load alerts specifically for the admin panel (for deletion)
        async function loadAdminAlerts() {
             if (!db || !firebaseInitialized) {
                 if(adminLoadingStatus) adminLoadingStatus.textContent = 'Error: Database not initialized.';
                 return;
            }
            if(adminLoadingStatus) adminLoadingStatus.textContent = 'Loading alerts...';
            if(adminAlertsList) adminAlertsList.innerHTML = ''; // Clear previous list

             try {
                // Simple query to get all alerts, ordered by time
                const q = query(collection(db, ALERTS_COLLECTION), orderBy('createdAt', 'desc'));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    if(adminLoadingStatus) adminLoadingStatus.textContent = 'No alerts found.';
                } else {
                    if(adminLoadingStatus) adminLoadingStatus.textContent = ''; // Hide loading message
                    querySnapshot.forEach((doc) => {
                        // Pass the full doc data including imagePath
                        displayAlert(doc.data(), doc.id, true); // Use isAdminView = true
                    });
                }
            } catch (error) {
                console.error("Error loading admin alerts: ", error);
                if(adminLoadingStatus) adminLoadingStatus.textContent = 'Error loading alerts.';
                 if (error.code === 'permission-denied') {
                     if(adminLoadingStatus) adminLoadingStatus.textContent += ' Check Firestore security rules.';
                 }
            }
        }


        // Handle adding a new alert
        if(addAlertForm) {
            addAlertForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                // Ensure auth object and currentUser are available, and Firebase is ready
                if (!auth || !auth.currentUser || !db || !storage || !firebaseInitialized) {
                     addAlertStatus.textContent = 'Error: Not logged in or services unavailable.';
                     console.error("Add alert prerequisite check failed:", { auth: !!auth, user: !!auth?.currentUser, db: !!db, storage: !!storage, firebaseInitialized });
                     return;
                }

                const imageFile = addAlertForm['alert-image'].files[0];
                const description = addAlertForm['alert-description'].value.trim();
                const armed = addAlertForm['add-armed'].value === 'yes'; // Boolean
                const locationVal = addAlertForm['add-location'].value;
                const crimeTypeVal = addAlertForm['add-crime-type'].value;
                const amountRangeVal = addAlertForm['add-amount'].value;

                // Basic validation
                if (!imageFile || !description || !addAlertForm['add-armed'].value || !locationVal || !crimeTypeVal || !amountRangeVal) {
                    addAlertStatus.textContent = 'Please fill in all fields and select an image.';
                    return;
                }
                 // Basic file type check (client-side)
                 if (!imageFile.type.startsWith('image/')) {
                     addAlertStatus.textContent = 'Please select a valid image file.';
                     return;
                 }
                 // Basic file size check (client-side, e.g., 5MB)
                 const maxSize = 5 * 1024 * 1024;
                 if (imageFile.size > maxSize) {
                     addAlertStatus.textContent = `Image size exceeds limit (${(maxSize / 1024 / 1024).toFixed(1)}MB).`;
                     return;
                 }

                // Disable form during upload
                addAlertBtn.disabled = true;
                addAlertInputs.forEach(input => input.disabled = true);
                addAlertStatus.textContent = 'Uploading alert...';

                try {
                    // 1. Upload Image to Firebase Storage
                    const uniqueFileName = `${Date.now()}_${imageFile.name}`;
                    const imageRef = ref(storage, `alerts/${uniqueFileName}`);
                    const metadata = { contentType: imageFile.type }; // Add content type metadata
                    const uploadResult = await uploadBytes(imageRef, imageFile, metadata);
                    const imageUrl = await getDownloadURL(uploadResult.ref);
                    const imagePath = imageRef.fullPath; // Get the full path
                    console.log('Image uploaded:', imageUrl);
                    console.log('Image path:', imagePath);

                    // 2. Add Alert Data to Firestore
                    const docRef = await addDoc(collection(db, ALERTS_COLLECTION), {
                        description: description,
                        imageUrl: imageUrl,
                        imagePath: imagePath, // Store the full storage path
                        armed: armed,
                        location: locationVal,
                        crimeType: crimeTypeVal,
                        amountRange: amountRangeVal,
                        createdAt: serverTimestamp(),
                        createdBy: auth.currentUser.uid
                    });

                    console.log("Alert added to Firestore with ID: ", docRef.id);
                    addAlertStatus.textContent = 'Alert added successfully!';
                    addAlertForm.reset(); // Clear the form fields
                    setTimeout(() => addAlertStatus.textContent = '', 3000); // Clear status message
                    loadAdminAlerts(); // Refresh the admin list
                    // Decide if public list needs immediate refresh or wait for next filter/load
                    // loadAlerts();

                } catch (error) {
                    console.error("Error adding alert:", error);
                    addAlertStatus.textContent = 'Error adding alert. See console.';
                     if (error.code && error.code.startsWith('storage/')) {
                         addAlertStatus.textContent = `Storage Error: ${error.message}. Check Storage rules.`;
                     } else if (error.code === 'permission-denied') {
                          addAlertStatus.textContent = 'Permission denied. Check Firestore/Storage rules.';
                     }
                } finally {
                     // Re-enable form
                     addAlertBtn.disabled = false;
                     addAlertInputs.forEach(input => input.disabled = false);
                }
            });
        }

        // Handle deleting an alert (event delegation on the list container)
        if(adminAlertsList) {
            adminAlertsList.addEventListener('click', async (e) => {
                 // Target the button specifically using its class
                const deleteButton = e.target.closest('.btn-delete-alert');
                 if (!deleteButton) return; // Ignore clicks not on the delete button itself

                 const alertDiv = deleteButton.closest('[data-id]'); // Find the parent div with data attributes
                 if (!alertDiv) return; // Should always find it if button exists

                 // Ensure prerequisites
                 if (!auth || !auth.currentUser || !db || !storage || !firebaseInitialized) {
                      console.error("Delete alert prerequisite check failed.");
                      alert('Cannot delete alert. Services unavailable or not logged in.');
                      return;
                 }

                 const alertId = alertDiv.dataset.id;
                 const imagePath = alertDiv.dataset.imagePath; // Get the stored image path

                 if (!alertId) {
                     console.error("Alert ID not found on element for deletion.");
                     return;
                 }

                 // Prevent accidental multiple clicks while deleting
                 if (deleteButton.disabled) return;

                 if (confirm('Are you sure you want to delete this alert? This cannot be undone.')) {
                     console.log(`Attempting to delete alert: ${alertId}, Image Path: ${imagePath}`);
                     // Add visual feedback that deletion is in progress
                     alertDiv.style.opacity = '0.5';
                     deleteButton.disabled = true; // Disable the button

                     try {
                         // 1. Delete Firestore Document
                         await deleteDoc(doc(db, ALERTS_COLLECTION, alertId));
                         console.log("Firestore document deleted.");

                         // 2. Delete Image from Storage ONLY if a valid path exists
                         if (imagePath && imagePath.startsWith('alerts/')) {
                             const imageRefToDelete = ref(storage, imagePath);
                             try {
                                 await deleteObject(imageRefToDelete);
                                 console.log("Storage image deleted successfully:", imagePath);
                             } catch (storageError) {
                                 console.error("Error deleting storage object:", storageError);
                                 // Log error but allow Firestore deletion to proceed
                                 if (storageError.code !== 'storage/object-not-found') {
                                     alert(`Firestore data deleted, but failed to delete image from storage: ${storageError.message}. You may need to delete it manually from the Firebase Console.`);
                                 } else {
                                     console.warn(`Storage object not found at path: ${imagePath}. It might have been deleted already.`);
                                 }
                             }
                         } else {
                             console.warn(`Invalid or missing image path ('${imagePath}') for alert ${alertId}. Skipping storage deletion.`);
                         }

                         console.log(`Alert ${alertId} deleted successfully.`);
                         alertDiv.remove(); // Remove from UI immediately after Firestore deletion
                         // Optionally refresh the public view if desired
                         // loadAlerts();

                     } catch (error) {
                         console.error("Error deleting alert:", error);
                         alert('Error deleting alert. Please try again.');
                         // Restore visual state if deletion failed
                         alertDiv.style.opacity = '1';
                         deleteButton.disabled = false; // Re-enable the button
                     }
                 }
            });
        }


        // --- Initialization on DOM Load ---
        document.addEventListener('DOMContentLoaded', () => {
             console.log("DOM Loaded. Initializing App.");
             populateStateDropdowns(); // Populate state selects
             checkTos(); // Check ToS status first (which calls loadAlerts if ok)
             checkAuthStateAndShowContent(); // Check login status and update UI
             handleRouteChange(); // Check initial URL hash (#admin)
        });

    </script>

</body>
</html>
